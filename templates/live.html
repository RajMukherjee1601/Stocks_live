<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Stock Prices ‚Äî NSE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
        Live Stock Price Viewer (NSE)
      </h1>
      <p class="text-slate-600 mt-1 text-sm">
        Use the same dropdown as the main dashboard to choose a stock and view live intraday prices
        as a <span class="font-medium">table</span> and a <span class="font-medium">chart</span>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-6">
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-end">
        <!-- üîª SAME DROPDOWN AS index.html -->
        <label class="w-full md:w-auto">
          <span class="block text-sm font-medium text-slate-700">Ticker (NSE)</span>
          <select id="tickerSelect"
                  class="mt-1 block w-80 rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2"></select>
        </label>

        <label class="w-full md:w-auto">
          <span class="block text-sm font-medium text-slate-700">Period</span>
          <select id="periodSelect"
                  class="mt-1 block w-40 rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
            <option value="1d">1 day</option>
            <option value="5d">5 days</option>
            <option value="1mo">1 month</option>
          </select>
        </label>

        <label class="w-full md:w-auto">
          <span class="block text-sm font-medium text-slate-700">Interval</span>
          <select id="intervalSelect"
                  class="mt-1 block w-40 rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
            <option value="5m">5 minutes</option>
            <option value="15m">15 minutes</option>
            <option value="30m">30 minutes</option>
            <option value="1h">1 hour</option>
          </select>
        </label>

        <button id="btnLoadLive"
                class="rounded-xl bg-emerald-600 text-white px-4 py-2 shadow hover:bg-emerald-500 active:scale-[.99] disabled:opacity-50">
          Load Live Data
        </button>

        <div id="spinner" class="hidden flex items-center gap-2 text-sm text-slate-600">
          <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="spinnerText">Loading‚Ä¶</span>
        </div>
      </div>

      <p class="text-xs text-slate-500 mt-2">
        Data is fetched from Yahoo Finance via your Flask backend each time you click ‚ÄúLoad Live Data‚Äù
        or change the dropdown.
      </p>
    </section>

    <!-- Status -->
    <section id="statusBox" class="mb-4 text-sm"></section>

    <!-- Last price -->
    <section id="lastPriceCard" class="hidden mb-6">
      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm flex items-center justify-between">
        <div>
          <p class="text-xs text-slate-500 uppercase tracking-wide">Last Price</p>
          <p id="lastPriceValue" class="text-2xl font-semibold text-slate-900"></p>
        </div>
        <div class="text-right">
          <p class="text-xs text-slate-500 uppercase tracking-wide">As of</p>
          <p id="lastPriceTs" class="text-sm text-slate-700"></p>
        </div>
      </div>
    </section>

    <!-- Chart + Table -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Chart -->
      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-lg font-semibold mb-3">Price Chart (Close)</h2>
        <canvas id="liveChart" height="250"></canvas>
      </div>

      <!-- Table -->
      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-lg font-semibold mb-3">Recent Intraday Data</h2>
        <div class="overflow-auto max-h-[400px]">
          <table class="min-w-full text-xs">
            <thead class="border-b text-slate-600 bg-slate-50 sticky top-0">
              <tr>
                <th class="px-2 py-1 text-left">Time</th>
                <th class="px-2 py-1 text-right">Open</th>
                <th class="px-2 py-1 text-right">High</th>
                <th class="px-2 py-1 text-right">Low</th>
                <th class="px-2 py-1 text-right">Close</th>
                <th class="px-2 py-1 text-right">Volume</th>
              </tr>
            </thead>
            <tbody id="liveTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-xs text-slate-500">
      <p>Live price viewer powered by Yahoo Finance (yfinance) on the backend, Chart.js for graphs.</p>
    </footer>
  </div>

  <script>
    // ===== Helper =====
    const $ = (sel) => document.querySelector(sel);

    // üîÅ same API_BASE logic as index.html
    const API_BASE = /^http(s)?:\/\//.test(location.origin) ? "" : "http://localhost:5000";

    // ===== SAME STOCKS MAP AS index.html =====
    const STOCKS = {
      "Reliance Industries (RELIANCE.NS)": "RELIANCE.NS",
      "TCS (TCS.NS)": "TCS.NS",
      "HDFC Bank (HDFCBANK.NS)": "HDFCBANK.NS",
      "ICICI Bank (ICICIBANK.NS)": "ICICIBANK.NS",
      "Infosys (INFY.NS)": "INFY.NS",
      "ITC (ITC.NS)": "ITC.NS",
      "State Bank of India (SBIN.NS)": "SBIN.NS",
      "Bharti Airtel (BHARTIARTL.NS)": "BHARTIARTL.NS",
      "Hindustan Unilever (HINDUNILVR.NS)": "HINDUNILVR.NS",
      "Larsen & Toubro (LT.NS)": "LT.NS",
      "Axis Bank (AXISBANK.NS)": "AXISBANK.NS",
      "Kotak Mahindra Bank (KOTAKBANK.NS)": "KOTAKBANK.NS",
      "Bajaj Finance (BAJFINANCE.NS)": "BAJFINANCE.NS",
      "Bajaj Finserv (BAJAJFINSV.NS)": "BAJAJFINSV.NS",
      "Adani Enterprises (ADANIENT.NS)": "ADANIENT.NS",
      "Adani Ports (ADANIPORTS.NS)": "ADANIPORTS.NS",
      "Maruti Suzuki (MARUTI.NS)": "MARUTI.NS",
      "Sun Pharma (SUNPHARMA.NS)": "SUNPHARMA.NS",
      "Asian Paints (ASIANPAINT.NS)": "ASIANPAINT.NS",
      "Mahindra & Mahindra (M&M.NS)": "M&M.NS",
      "Tata Motors (TATAMOTORS.NS)": "TATAMOTORS.NS",
      "NTPC (NTPC.NS)": "NTPC.NS",
      "Power Grid (POWERGRID.NS)": "POWERGRID.NS",
      "UltraTech Cement (ULTRACEMCO.NS)": "ULTRACEMCO.NS",
      "JSW Steel (JSWSTEEL.NS)": "JSWSTEEL.NS",
      "Tata Steel (TATASTEEL.NS)": "TATASTEEL.NS",
      "Nestl√© India (NESTLEIND.NS)": "NESTLEIND.NS",
      "Titan (TITAN.NS)": "TITAN.NS",
      "Tech Mahindra (TECHM.NS)": "TECHM.NS",
      "Wipro (WIPRO.NS)": "WIPRO.NS",
      "Grasim (GRASIM.NS)": "GRASIM.NS",
      "Cipla (CIPLA.NS)": "CIPLA.NS",
      "Divi's Laboratories (DIVISLAB.NS)": "DIVISLAB.NS",
      "Dr. Reddy's (DRREDDY.NS)": "DRREDDY.NS",
      "Britannia (BRITANNIA.NS)": "BRITANNIA.NS",
      "Eicher Motors (EICHERMOT.NS)": "EICHERMOT.NS",
      "Hero MotoCorp (HEROMOTOCO.NS)": "HEROMOTOCO.NS",
      "Bajaj Auto (BAJAJ-AUTO.NS)": "BAJAJ-AUTO.NS",
      "Tata Consumer (TATACONSUM.NS)": "TATACONSUM.NS",
      "HDFC Life (HDFCLIFE.NS)": "HDFCLIFE.NS",
      "SBI Life (SBILIFE.NS)": "SBILIFE.NS",
      "ICICI Lombard (ICICIGI.NS)": "ICICIGI.NS",
      "Hindalco (HINDALCO.NS)": "HINDALCO.NS",
      "Coal India (COALINDIA.NS)": "COALINDIA.NS",
      "ONGC (ONGC.NS)": "ONGC.NS",
      "LTIMindtree (LTIM.NS)": "LTIM.NS",
      "Apollo Hospitals (APOLLOHOSP.NS)": "APOLLOHOSP.NS",
      "Avenue Supermarts (DMART.NS)": "DMART.NS",
      "DLF (DLF.NS)": "DLF.NS",
      "Godrej Consumer (GODREJCP.NS)": "GODREJCP.NS",
      "BSE Limited (BSE.NS)": "BSE.NS",
      "UPL (UPL.NS)": "UPL.NS",
      "Dixon Technologies (DIXON.NS)": "DIXON.NS",
      "Suzlon Energy (SUZLON.NS)": "SUZLON.NS",
      "Coforge (COFORGE.NS)": "COFORGE.NS",
      "Brigade Enterprises (BRIGADE.NS)": "BRIGADE.NS"
    };

    const status = (msg, type = "info") => {
      const box = $("#statusBox");
      const base = "rounded-xl px-4 py-3 shadow border mb-3";
      const palette = {
        info: "bg-sky-50 border-sky-200 text-sky-900",
        success: "bg-emerald-50 border-emerald-200 text-emerald-900",
        warn: "bg-amber-50 border-amber-200 text-amber-900",
        error: "bg-rose-50 border-rose-200 text-rose-900",
      };
      const card = document.createElement("div");
      card.className = base + " " + (palette[type] || palette.info);
      card.textContent = msg;
      box.prepend(card);
    };

    const setBusy = (busy, text = "Loading‚Ä¶") => {
      $("#spinnerText").textContent = text;
      $("#spinner").classList.toggle("hidden", !busy);
      $("#btnLoadLive").disabled = busy;
      $("#tickerSelect").disabled = busy;
      $("#periodSelect").disabled = busy;
      $("#intervalSelect").disabled = busy;
    };

    // ‚úÖ EXACTLY LIKE index.html
    const buildTickerDropdown = () => {
      const sel = $("#tickerSelect");
      sel.innerHTML = "";
      for (const [label, symbol] of Object.entries(STOCKS)) {
        const opt = document.createElement("option");
        opt.value = symbol;
        opt.textContent = label;
        sel.appendChild(opt);
      }
      sel.value = "RELIANCE.NS"; // default
    };

    const getTicker = () => {
      const v = $("#tickerSelect").value;
      if (!v) throw new Error("Please choose a ticker.");
      return v;
    };

    let liveChart;

    const renderLiveData = (payload) => {
      const rows = payload.data || [];

      // last price card
      $("#lastPriceValue").textContent = payload.last_price.toFixed(2);
      const ts = payload.last_timestamp ? new Date(payload.last_timestamp) : null;
      $("#lastPriceTs").textContent = ts ? ts.toLocaleString() : "‚Äî";
      $("#lastPriceCard").classList.remove("hidden");

      // table (most recent first)
      const tbody = $("#liveTableBody");
      tbody.innerHTML = "";
      const dataDesc = [...rows].reverse();
      dataDesc.forEach((r) => {
        const tr = document.createElement("tr");
        tr.className = "border-b last:border-0";
        const t = new Date(r.timestamp);
        const timeStr = t.toLocaleString();

        const cells = [
          { text: timeStr, align: "text-left" },
          { text: r.open.toFixed(2), align: "text-right" },
          { text: r.high.toFixed(2), align: "text-right" },
          { text: r.low.toFixed(2), align: "text-right" },
          { text: r.close.toFixed(2), align: "text-right" },
          { text: r.volume.toLocaleString(), align: "text-right" },
        ];

        cells.forEach((c) => {
          const td = document.createElement("td");
          td.className = "px-2 py-1 " + c.align;
          td.textContent = c.text;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // chart (oldest ‚Üí newest)
      const labels = rows.map(r => {
        const d = new Date(r.timestamp);
        return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      });
      const values = rows.map(r => r.close);

      const ctx = $("#liveChart");
      if (liveChart) liveChart.destroy();
      liveChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: `Close Price (${payload.interval}, ${payload.period})`,
            data: values,
            fill: false,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { title: { display: true, text: "Time" } },
            y: { title: { display: true, text: "Price" }, beginAtZero: false }
          }
        }
      });
    };

    const loadLive = async () => {
      const ticker = getTicker();
      const period = $("#periodSelect").value;
      const interval = $("#intervalSelect").value;

      setBusy(true, `Loading live data for ${ticker}‚Ä¶`);
      try {
        const url = `${API_BASE}/api/live_price?ticker=${encodeURIComponent(ticker)}&period=${encodeURIComponent(period)}&interval=${encodeURIComponent(interval)}`;
        const res = await fetch(url);
        const j = await res.json();
        if (!res.ok || !j.ok) {
          throw new Error(j.error || "Live price fetch failed");
        }
        renderLiveData(j);
        status(`Loaded live data for ${j.ticker} (${j.period}, ${j.interval}).`, "success");
      } catch (e) {
        console.error(e);
        status(`Error loading live data: ${e.message}`, "error");
      } finally {
        setBusy(false);
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      buildTickerDropdown();              // üîë this actually fills the dropdown
      $("#btnLoadLive").addEventListener("click", loadLive);
      $("#tickerSelect").addEventListener("change", loadLive); // change ticker = reload
      loadLive(); // auto-load default ticker once
    });
  </script>
</body>
</html>
