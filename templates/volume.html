<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Volume Table — Last 5 Days</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-extrabold tracking-tight">Volume Table (Last 5 Days)</h1>
      <p class="text-slate-600 mt-1" id="subtitle">Loading ticker…</p>
    </header>

    <div id="statusBox" class="hidden mb-4"></div>

    <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Daily Volumes</h2>
        <div class="text-xs text-slate-500">
          Data source: Yahoo Finance (Total Volume)
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b border-slate-200 bg-slate-50">
              <th class="px-3 py-2 text-left font-semibold">Date</th>
              <th class="px-3 py-2 text-right font-semibold">Total Volume</th>
              <th class="px-3 py-2 text-right font-semibold">Delivery Volume</th>
              <th class="px-3 py-2 text-right font-semibold">Credit Volume</th>
            </tr>
          </thead>
          <tbody id="volumeTbody"></tbody>
        </table>
      </div>

      <p class="mt-4 text-xs text-slate-500">
        Note: Delivery vs credit volume requires NSE end-of-day data.
        For now, only total traded volume is shown.
      </p>
    </div>
  </div>

  <script>
    const API_BASE = /^http(s)?:\/\//.test(location.origin) ? "" : "http://localhost:5000";
    const $ = (sel) => document.querySelector(sel);

    const fmtInt = (v) => {
      if (v === null || v === undefined || isNaN(v)) return "—";
      return Number(v).toLocaleString();
    };

    function getQueryParam(name, fallback = null) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || fallback;
    }

    function setStatus(msg, type = "info") {
      const box = $("#statusBox");
      const base = "rounded-xl px-4 py-3 text-sm shadow border";
      const palette = {
        info: "bg-sky-50 border-sky-200 text-sky-900",
        success: "bg-emerald-50 border-emerald-200 text-emerald-900",
        error: "bg-rose-50 border-rose-200 text-rose-900"
      };
      box.className = base + " " + (palette[type] || palette.info);
      box.textContent = msg;
      box.classList.remove("hidden");
    }

    async function loadVolumeTable() {
      const ticker = getQueryParam("ticker", "RELIANCE.NS");
      $("#subtitle").textContent = `Ticker: ${ticker} — last 5 trading days`;

      try {
        const url = `${API_BASE}/api/volume_table?ticker=${encodeURIComponent(ticker)}&days=5`;
        const res = await fetch(url);
        const j = await res.json();

        if (!j.ok) {
          setStatus(j.error || "API error loading volume table", "error");
          return;
        }

        const tbody = $("#volumeTbody");
        tbody.innerHTML = "";

        if (!j.rows || !j.rows.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="px-3 py-3 text-center text-slate-500">
                No volume data available.
              </td>
            </tr>`;
          return;
        }

        j.rows.forEach(row => {
          const tr = document.createElement("tr");
          tr.className = "border-b border-slate-100 hover:bg-slate-50";
          tr.innerHTML = `
            <td class="px-3 py-2">${row.date}</td>
            <td class="px-3 py-2 text-right font-medium">${fmtInt(row.total_volume)}</td>
            <td class="px-3 py-2 text-right text-slate-400">—</td>
            <td class="px-3 py-2 text-right text-slate-400">—</td>
          `;
          tbody.appendChild(tr);
        });

        setStatus("Loaded volume data successfully.", "success");
      } catch (err) {
        console.error(err);
        setStatus("Failed to load volume data: " + err.message, "error");
      }
    }

    document.addEventListener("DOMContentLoaded", loadVolumeTable);
  </script>
</body>
</html>
