<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hourly Forecast (Next 3 Hours)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121923;
      --panel-2: #0f1620;
      --text: #e7eef7;
      --muted: #94a3b8;
      --accent: #60a5fa;
      --ok: #34d399;
      --warn: #fbbf24;
      --err: #f87171;
      --border: #1f2a37;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, #142135 0%, var(--bg) 40%),
                  radial-gradient(1400px 700px at 90% -10%, #102237 0%, var(--bg) 45%), var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    .title {
      display: flex; align-items: center; gap: 12px; margin-bottom: 18px;
    }
    .badge { font-size: 12px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); }
    .card { background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border: 1px solid var(--border); border-radius: 16px; padding: 18px; }
    .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    /* Form */
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"] {
      width: 100%;
      background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 12px; outline: none;
    }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .field { min-width: 180px; flex: 1 1 220px; }
    .btn {
      background: var(--accent); color: #06121f; font-weight: 700; border: 0; border-radius: 12px; padding: 12px 18px;
      cursor: pointer; transition: transform .06s ease, filter .2s ease;
    }
    .btn[disabled] { opacity: .7; cursor: progress; }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }

    /* Results */
    .section-title { font-weight: 600; margin: 14px 0 10px; color: #c9e3ff; }
    .kps { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kp { background: #0b1220; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .kp .k { font-size: 12px; color: var(--muted); }
    .kp .v { font-size: 16px; font-weight: 700; letter-spacing: .2px; margin-top: 4px; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { color: var(--muted); font-weight: 600; }

    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; color: #bcd7ff;
           background: #08101a; border: 1px dashed var(--border); border-radius: 12px; padding: 12px; white-space: pre-wrap; }

    .footer { margin: 26px 0 10px; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1 style="margin:0;font-size:26px;font-weight:800;letter-spacing:.2px">Next‑3‑Hour Forecast</h1>
      <span class="badge">1‑hour bars • 1‑year history (server)</span>
    </div>

    <div class="card" style="margin-bottom:16px">
      <form id="predictForm" onsubmit="return false;">
        <div class="row">
          <div class="field">
            <label for="ticker">Ticker (Yahoo symbol)</label>
            <input id="ticker" type="text" placeholder="e.g. RELIANCE.NS" value="RELIANCE.NS" required />
          </div>
          <div class="field" style="max-width:160px">
            <label for="lags">Lags</label>
            <input id="lags" type="number" inputmode="numeric" min="3" max="96" step="1" value="12" />
          </div>
          <div class="field" style="max-width:160px">
            <label for="steps">Steps (fixed at 3)</label>
            <input id="steps" type="number" inputmode="numeric" value="3" min="3" max="3" readonly />
          </div>
          <div class="field" style="flex:0 0 auto">
            <button id="go" class="btn" type="button">Predict</button>
          </div>
        </div>
        <p class="hint">This calls <code>/api/predict_1h?ticker=&lt;symbol&gt;&amp;lags=&lt;n&gt;&amp;steps=3</code>. Ensure your Flask backend has the <code>/api/predict_1h</code> endpoint.
        </p>
      </form>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-title">Forecast Overview</div>
        <div class="kps" id="kps">
          <div class="kp"><div class="k">Ticker</div><div class="v" id="kpTicker">—</div></div>
          <div class="kp"><div class="k">Last Timestamp</div><div class="v" id="kpLast">—</div></div>
          <div class="kp"><div class="k">Interval</div><div class="v" id="kpInt">—</div></div>
        </div>

        <div class="section-title" style="margin-top:14px">Next 3 Hours</div>
        <table>
          <thead>
            <tr><th>#</th><th>Time (ISO)</th><th>Predicted Close</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="section-title">Chart</div>
        <canvas id="chart" height="280"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="section-title">Raw Response</div>
      <pre class="log" id="log">—</pre>
    </div>

    <div class="footer">Tip: serve this file alongside your Flask app so relative <code>/api/*</code> calls hit the same origin.</div>
  </div>

  <script>
    let chart;
    function setBusy(busy) {
      const btn = document.getElementById('go');
      btn.disabled = !!busy;
      btn.textContent = busy ? 'Predicting…' : 'Predict';
    }

    function fmt(v) {
      if (v === null || v === undefined || Number.isNaN(v)) return '—';
      return Number(v).toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function renderTable(horizon, preds) {
      const tb = document.getElementById('rows');
      tb.innerHTML = '';
      horizon.forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${t}</td><td><strong>${fmt(preds[i])}</strong></td>`;
        tb.appendChild(tr);
      });
    }

    function renderKPs(json) {
      document.getElementById('kpTicker').textContent = json.ticker || '—';
      document.getElementById('kpLast').textContent = json.last_ts || '—';
      document.getElementById('kpInt').textContent = json.interval || '—';
    }

    function renderChart(labels, values, ticker) {
      const ctx = document.getElementById('chart');
      if (chart) { chart.destroy(); }
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `${ticker || ''} • next 3 hours`,
            data: values,
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 3,
            fill: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, labels: { color: '#cfe3ff' } },
            tooltip: { intersect: false, mode: 'index' }
          },
          scales: {
            x: { ticks: { color: '#b6c6dd' }, grid: { color: '#1a2633' } },
            y: { ticks: { color: '#b6c6dd' }, grid: { color: '#1a2633' } }
          }
        }
      });
    }

    async function doPredict() {
      const ticker = document.getElementById('ticker').value.trim();
      const lags = parseInt(document.getElementById('lags').value, 10) || 12;
      const steps = 3; // fixed
      if (!ticker) { alert('Please enter a ticker symbol.'); return; }

      const url = `/api/predict_1h?ticker=${encodeURIComponent(ticker)}&lags=${lags}&steps=${steps}`;

      try {
        setBusy(true);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        document.getElementById('log').textContent = JSON.stringify(json, null, 2);
        renderKPs(json);
        renderTable(json.horizon || [], json.predictions || []);
        renderChart(json.horizon || [], json.predictions || [], json.ticker);
      } catch (err) {
        console.error(err);
        document.getElementById('log').textContent = `Error: ${err.message}`;
        renderTable([], []);
        renderChart([], [], '');
      } finally {
        setBusy(false);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('go').addEventListener('click', doPredict);
    });
  </script>
</body>
</html>